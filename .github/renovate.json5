{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "github>grafana/sm-renovate//presets/grafana.json5",
    "github>grafana/sm-renovate//presets/synthetic-monitoring.json5",
    "github>grafana/sm-renovate//presets/alpine-packages.json5"
  ],
  "ignorePresets": [
    "github>grafana/grafana-renovate-config//presets/shared-workflows",
    "github>grafana/grafana-renovate-config//presets/automerge"
  ],
  "packageRules": [
    {
      // Update alpine itself and all dependencies in the same PR. This ensures consistency, e.g. renovate does not
      // attempt to update chromium without updating alpine if an update for the latter is also available, as that PR
      // would fail.
      "matchFileNames": [
        "Dockerfile"
      ],
      "groupName": "Dockerfile",
      // Allow renovate to automatically merge PRs created for these packages. Renovate automatically checks CI/CD
      // status and will _not_ automerge PRs which have failures.
      "automerge": true,
      // Disable minimumReleaseAge. As this setting is inherited from the default config in
      // https://github.com/grafana/deployment_tools/blob/16231ba00eac9310d2360a2075a96b1106a02c34/ksonnet/lib/renovate-self-hosted/renovate.jsonnet#L33
      // We need to do this because renovate cannot figure out the release date of chromium packages, as those are
      // parsed from the HTML page at https://dl-cdn.alpinelinux.org/alpine/latest-stable/community/x86_64/.
      "minimumReleaseAge": "",
      // Do not separate majors and minors for this group. This allows a major version bump (which chromium typically
      // has) to share the branch with a minior version bump (which alpine typically has).
      "separateMajorMinor": false,
    },
  ],
  "customManagers": [
    {
      // Update alpine tag, which is stored in an ARG for easy greppability.
      "customType": "regex",
      "depNameTemplate": "alpine",
      "datasourceTemplate": "docker",
      "managerFilePatterns": [
        "Dockerfile"
      ],
      "matchStrings": [
        "ALPINE_VERSION=(?<currentValue>[^@\\s]+)(?:@(?<currentDigest>\\S+))?"
      ]
    },
    {
      // Update chromium version from alpine packages.
      "customType": "regex",
      "managerFilePatterns": [
        "Dockerfile",
      ],
      "matchStrings": [
        "CHROMIUM_VERSION=(?<currentValue>[-.\\w]+)"
      ],
      "depNameTemplate": "chromium",
      "versioningTemplate": "loose", // The most lenient versioning renovate supports.
      // We use two different datasources for main and community, as alpine serves them in different URLs.
      "datasourceTemplate": "custom.alpine-community",
      // Extracted "versions" include the package name, so here we strip that prefix using a regex.
      "extractVersionTemplate": "^chromium-(?<version>\\d.+).apk$",
    },
  ]
}
